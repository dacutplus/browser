<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Browser Inside a Browser</title>
    <style>
        /* Global reset and dark gradient background */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
        }

        /* The outer shell that holds the dock and the workspace */
        .desktop {
            display: flex;
            height: calc(100vh - 16px);
            margin: 8px;
            border-radius: 12px;
            backdrop-filter: blur(20px);
            background: rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        /* Left-hand dock holding app icons */
        .dock {
            width: 80px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(30px);
            border-radius: 12px 0 0 12px;
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
        position: relative;
        }

        /* Special styling for the "Add App" button at the bottom of the dock */
        .add-app-icon {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 28px;
        }

        .add-app-icon:hover {
            background: rgba(255, 255, 255, 0.3);
            color: #fff;
            transform: translateX(-50%) scale(1.05);
        }

        /* Settings button (gear icon) styling in the dock */
        .settings-btn {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 22px;
        }

        .settings-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            color: #fff;
            transform: translateX(-50%) scale(1.05);
        }

        /* Settings panel overlay */
        .settings-panel {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .settings-content {
            background: #fff;
            color: #333;
            padding: 20px;
            border-radius: 8px;
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
        }

        .settings-content h3 {
            margin-bottom: 12px;
        }

        .settings-row {
            display: grid;
            grid-template-columns: 80px 80px 1fr 24px 24px 50px;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .settings-row input {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .settings-row button {
            border: none;
            background: #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            padding: 4px;
        }

        .settings-row button:hover {
            background: #d0d0d0;
        }

        .app-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            font-size: 24px;
        }

        .app-icon:hover {
            transform: translateY(-3px);
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .app-icon.active {
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }

        .app-icon.active::after {
            content: '';
            position: absolute;
            right: -12px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 30px;
            background: #fff;
            border-radius: 2px;
        }

        /* Delete button overlay on each app icon */
        .app-delete {
            position: absolute;
            top: -6px;
            right: -6px;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(255, 0, 0, 0.8);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            opacity: 0;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .app-icon:hover .app-delete {
            opacity: 1;
        }

        .app-name {
            position: absolute;
            bottom: -22px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: rgba(255, 255, 255, 0.8);
            white-space: nowrap;
        }

        /* Main workspace area containing the tab bar, URL bar, and content */
        .workspace {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0 12px 12px 0;
        }

        /* Tab strip styling */
        .tab-bar {
            height: 48px;
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0 12px;
            overflow-x: auto;
        }

        .tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.8);
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s ease;
            white-space: nowrap;
            min-width: 100px;
            border: 1px solid transparent;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.4);
            color: #fff;
        }

        .tab-close {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .tab-close:hover {
            background: rgba(255, 100, 100, 0.8);
        }

        .new-tab-btn {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            transition: background 0.2s ease;
            font-size: 18px;
        }

        .new-tab-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            color: #fff;
        }

        /* URL bar styling */
        .url-bar {
            height: 42px;
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 0 12px;
        }

        .url-input {
            flex: 1;
            border: none;
            border-radius: 20px;
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            font-size: 13px;
        }

        .url-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .url-input:focus {
            outline: 2px solid rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.2);
        }

        .nav-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: none;
            background: rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            color: #fff;
        }

        .nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Main content area containing iframe containers */
        .content-area {
            flex: 1;
            position: relative;
            background: rgba(255, 255, 255, 0.05);
            overflow: hidden;
        }

        .iframe-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            border-radius: 0 0 12px 0;
            overflow: hidden;
            background: #fff;
        }

        .iframe-container.active {
            display: block;
        }

        .iframe-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Welcome screen displayed when no app is selected */
        .welcome-screen {
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #fff;
            text-align: center;
            background: rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body>
    <div class="desktop">
        <div class="dock" id="dock">
            <!-- Add app button is rendered here so it stays at the bottom -->
            <div class="add-app-icon" id="addAppBtn">+</div>
            <!-- Settings button to manage workspaces -->
            <div class="settings-btn" id="settingsBtn">⚙️</div>
        </div>
        <div class="workspace">
            <div class="tab-bar" id="tabBar">
                <button class="new-tab-btn" id="newTabBtn">+</button>
            </div>
            <div class="url-bar">
                <button class="nav-btn" id="backBtn">←</button>
                <button class="nav-btn" id="forwardBtn">→</button>
                <button class="nav-btn" id="refreshBtn">↻</button>
                <!-- Button to open current tab in a new browser tab -->
                <button class="nav-btn" id="externalBtn">↗</button>
                <input type="text" class="url-input" id="urlInput" placeholder="Enter URL or search...">
            </div>
            <div class="content-area" id="contentArea">
                <div class="welcome-screen" id="welcomeScreen">
                    <h2>Welcome to Your Virtual Desktop</h2>
                    <p>Select an app from the dock or open a new tab to start browsing.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        /**
         * VirtualDesktop class: Manages the list of apps, tabs, and navigation state.
         */
        class VirtualDesktop {
            constructor() {
                // Load persisted state if available
                const persisted = this.loadState();
                this.apps = new Map();
                this.currentApp = null;
                this.tabCounter = 0;

                if (persisted) {
                    // Restore apps, tabs, and active states from persisted data
                    Object.values(persisted.apps).forEach(app => {
                        this.apps.set(app.id, {
                            id: app.id,
                            name: app.name,
                            icon: app.icon,
                            defaultUrl: app.defaultUrl,
                            tabs: app.tabs || [],
                            activeTabId: app.activeTabId || null
                        });
                    });
                    this.currentApp = persisted.currentApp;
                    this.tabCounter = persisted.tabCounter || 0;
                    // Render the dock and restore UI
                    this.renderDock();
                    if (this.currentApp) {
                        this.switchToApp(this.currentApp);
                    }
                } else {
                    // Initialize default apps
                    this.initializeApps();
                }
                this.bindEvents();
            }

            /**
             * Load persisted state from localStorage, if any.
             * @returns {object|null} The persisted state or null if nothing was saved.
             */
            loadState() {
                try {
                    const saved = localStorage.getItem('virtualDesktopState');
                    return saved ? JSON.parse(saved) : null;
                } catch {
                    return null;
                }
            }

            /**
             * Save the current state to localStorage. Converts Map to plain object.
             */
            saveState() {
                const appsObj = {};
                this.apps.forEach((app, id) => {
                    appsObj[id] = {
                        id: app.id,
                        name: app.name,
                        icon: app.icon,
                        defaultUrl: app.defaultUrl,
                        tabs: app.tabs,
                        activeTabId: app.activeTabId
                    };
                });
                const state = {
                    apps: appsObj,
                    currentApp: this.currentApp,
                    tabCounter: this.tabCounter
                };
                try {
                    localStorage.setItem('virtualDesktopState', JSON.stringify(state));
                } catch {
                    // Ignore storage errors (e.g., in incognito)
                }
            }

            /**
             * Render the dock icons based on the current list of apps. Clears existing icons first.
             */
            renderDock() {
                const dock = document.getElementById('dock');
                // Remove existing app icons but keep the Add App button
                dock.querySelectorAll('.app-icon').forEach(elem => elem.remove());
                const addBtn = dock.querySelector('.add-app-icon');

                this.apps.forEach(app => {
                    const iconElem = document.createElement('div');
                    iconElem.className = 'app-icon';
                    iconElem.dataset.appId = app.id;
                    iconElem.innerHTML = `
                        ${app.icon}
                        <div class="app-name">${app.name}</div>
                    `;
                    // Switch to the app when clicking on the icon
                    iconElem.addEventListener('click', () => this.switchToApp(app.id));
                    // Add a delete button overlay
                    const deleteBtn = document.createElement('div');
                    deleteBtn.className = 'app-delete';
                    deleteBtn.textContent = '×';
                    deleteBtn.addEventListener('click', e => {
                        e.stopPropagation();
                        this.deleteApp(app.id);
                    });
                    iconElem.appendChild(deleteBtn);
                    // Insert icons before the add button so the add button stays at the bottom
                    dock.insertBefore(iconElem, addBtn);
                    if (this.currentApp === app.id) {
                        iconElem.classList.add('active');
                    }
                });
            }

            /**
             * Initialize the apps displayed in the dock. Each app has a name, icon, and default URL.
             */
            initializeApps() {
                const appConfigs = [
                    { id: 'facebook', name: 'Dutchie Admin', icon: '🅓', defaultUrl: 'https://admin.dutchie.com/enterprise/99c445a0-96c9-4f92-888f-8540c6304a12/dispensaries' },
                    { id: 'gmail', name: 'MESA', icon: 'Ⓜ️', defaultUrl: 'https://mesa.backoffice.dutchie.com/' },
                    { id: 'youtube', name: 'Monday', icon: '🅜', defaultUrl: 'https://monday.com' },
                    { id: 'twitter', name: 'Edge', icon: '⭐️', defaultUrl: 'https://business.ouredge.com/auth?redirect=%2Fdashboard' },
                    
                ];

                // Populate the default apps into the Map
                appConfigs.forEach(config => {
                    this.apps.set(config.id, {
                        id: config.id,
                        name: config.name,
                        icon: config.icon,
                        defaultUrl: config.defaultUrl,
                        tabs: [],
                        activeTabId: null
                    });
                });
                // Render dock icons and persist the initial state
                this.renderDock();
                this.saveState();
            }

            /**
             * Bind events for global controls such as new tab, URL navigation, and navigation buttons.
             */
            bindEvents() {
                document.getElementById('newTabBtn').addEventListener('click', () => {
                    // If an app is selected, create a tab for that app; otherwise use a generic browser app
                    const targetApp = this.currentApp || 'browser';
                    this.createTab(targetApp);
                });

                // Handle pressing Enter in the URL bar to navigate
                document.getElementById('urlInput').addEventListener('keydown', e => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const url = e.target.value.trim();
                        if (url) {
                            this.navigateToUrl(url);
                        }
                    }
                });

                // Navigation buttons
                document.getElementById('backBtn').addEventListener('click', () => this.goBack());
                document.getElementById('forwardBtn').addEventListener('click', () => this.goForward());
                document.getElementById('refreshBtn').addEventListener('click', () => this.refresh());

                // Add app button: prompt user for new app details and persist it
                const addAppBtn = document.getElementById('addAppBtn');
                addAppBtn.addEventListener('click', () => this.addApp());

                // Settings button: open settings panel
                const settingsBtn = document.getElementById('settingsBtn');
                settingsBtn.addEventListener('click', () => this.openSettings());

                // Settings close button: close settings panel
                const settingsClose = document.getElementById('settingsClose');
                settingsClose.addEventListener('click', () => this.closeSettings());

                // External open button: open current tab in a new browser tab
                const externalBtn = document.getElementById('externalBtn');
                externalBtn.addEventListener('click', () => this.openExternal());
            }

            /**
             * Switch to a specific app when its icon is clicked. Activates the app's tab list.
             * @param {string} appId - The identifier of the app to switch to.
             */
            switchToApp(appId) {
                // Update active class on dock icons
                document.querySelectorAll('.app-icon').forEach(elem => elem.classList.remove('active'));
                const iconElem = document.querySelector(`.app-icon[data-app-id="${appId}"]`);
                if (iconElem) {
                    iconElem.classList.add('active');
                }

                this.currentApp = appId;
                const app = this.getOrCreateApp(appId);

                // If this app has no tabs yet, open its default URL
                if (app.tabs.length === 0) {
                    this.createTab(appId, app.defaultUrl);
                } else {
                    // Otherwise render tabs and show the active one
                    this.renderTabs(appId);
                    this.showTab(app.activeTabId);
                }
                // Persist the current state after switching apps
                this.saveState();
            }

            /**
             * Create a new tab for the given app. Optionally provide a URL to load.
             * @param {string} appId - The identifier of the app for which to create the tab.
             * @param {string|null} url - The URL to load in the tab. Defaults to about:blank.
             */
            createTab(appId, url = null) {
                const app = this.getOrCreateApp(appId);
                const tabId = `tab-${++this.tabCounter}`;
                const tabUrl = url || 'about:blank';
                const tabTitle = url ? this.extractTitleFromUrl(url) : 'New Tab';

                const newTab = { id: tabId, url: tabUrl, title: tabTitle, appId: appId };
                app.tabs.push(newTab);
                app.activeTabId = tabId;

                // Create iframe container for the tab
                const container = document.createElement('div');
                container.className = 'iframe-container';
                container.id = tabId;
                if (tabUrl !== 'about:blank') {
                    // Insert an iframe and listen for load events to update the tab title
                    container.innerHTML = `<iframe src="${tabUrl}" sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation"></iframe>`;
                    const iframe = container.querySelector('iframe');
                    iframe.addEventListener('load', () => {
                        try {
                            const pageTitle = iframe.contentDocument.title;
                            if (pageTitle) {
                                newTab.title = pageTitle;
                                this.renderTabs(appId);
                                this.saveState();
                            }
                        } catch (e) {
                            // Cannot access cross-origin iframe; ignore
                        }
                    });
                }
                document.getElementById('contentArea').appendChild(container);

                this.renderTabs(appId);
                this.showTab(tabId);
                this.saveState();
            }

            /**
             * Render the tab bar for the given app, creating clickable elements for each tab.
             * @param {string} appId - The identifier of the app whose tabs should be rendered.
             */
            renderTabs(appId) {
                const tabBar = document.getElementById('tabBar');
                // Remove existing tabs (but keep the new tab button intact)
                tabBar.querySelectorAll('.tab').forEach(elem => elem.remove());

                const app = this.getOrCreateApp(appId);
                app.tabs.forEach(tab => {
                    const tabElem = document.createElement('div');
                    tabElem.className = 'tab';
                    tabElem.dataset.tabId = tab.id;
                    tabElem.innerHTML = `<span>${tab.title}</span><div class="tab-close">×</div>`;

                    if (tab.id === app.activeTabId) tabElem.classList.add('active');

                    // Clicking the tab selects it
                    tabElem.addEventListener('click', () => this.showTab(tab.id));
                    // Clicking the close button removes it (stop propagation so the tab doesn't activate first)
                    tabElem.querySelector('.tab-close').addEventListener('click', ev => {
                        ev.stopPropagation();
                        this.closeTab(tab.id, appId);
                    });

                    // Insert before the new tab button (which is the first child)
                    tabBar.insertBefore(tabElem, document.getElementById('newTabBtn'));
                });
            }

            /**
             * Show a tab by making its iframe container visible and updating the active tab state.
             * @param {string} tabId - The identifier of the tab to display.
             */
            showTab(tabId) {
                // Hide all tab containers
                document.querySelectorAll('.iframe-container').forEach(container => {
                    container.classList.remove('active');
                });

                // Hide welcome screen when switching to an app
                document.getElementById('welcomeScreen').style.display = 'none';

                // Show selected tab's container
                const container = document.getElementById(tabId);
                if (container) {
                    container.classList.add('active');
                }

                // Update active tab styling
                document.querySelectorAll('.tab').forEach(elem => {
                    elem.classList.remove('active');
                });
                const activeTabElem = document.querySelector(`.tab[data-tab-id="${tabId}"]`);
                if (activeTabElem) {
                    activeTabElem.classList.add('active');
                }

                // Update current app's active tab reference and URL bar
                if (this.currentApp) {
                    const app = this.getOrCreateApp(this.currentApp);
                    app.activeTabId = tabId;
                    const tabInfo = app.tabs.find(t => t.id === tabId);
                    if (tabInfo) document.getElementById('urlInput').value = tabInfo.url;
                }
            }

            /**
             * Close a tab, removing it from the DOM and from the app's tab list.
             * @param {string} tabId - The identifier of the tab to remove.
             * @param {string} appId - The identifier of the app this tab belongs to.
             */
            closeTab(tabId, appId) {
                const app = this.getOrCreateApp(appId);
                const index = app.tabs.findIndex(t => t.id === tabId);
                if (index !== -1) {
                    app.tabs.splice(index, 1);
                    document.getElementById(tabId)?.remove();

                    // If closing the active tab, adjust active tab selection
                    if (app.activeTabId === tabId) {
                        if (app.tabs.length > 0) {
                            const nextTab = app.tabs[Math.max(0, index - 1)];
                            this.showTab(nextTab.id);
                        } else {
                            app.activeTabId = null;
                            document.getElementById('urlInput').value = '';
                            // Show welcome screen if no tabs remain in the current app
                            document.getElementById('welcomeScreen').style.display = 'flex';
                        }
                    }
                    this.renderTabs(appId);
                    this.saveState();
                }
            }

            /**
             * Navigate the current tab to a given URL or search query.
             * @param {string} url - The URL or search term entered by the user.
             */
            navigateToUrl(url) {
                // Prepend protocol for bare domains or build a Google search for terms
                let finalUrl = url;
                // If the URL lacks a scheme (e.g., http:// or https://), prepend https or build a search query
                if (!/^[a-zA-Z]+:\/\//.test(url)) {
                    finalUrl = url.includes('.') ? `https://${url}` : `https://www.google.com/search?q=${encodeURIComponent(url)}`;
                }

                // Find current tab and update its URL and title. If no current app, create a new generic browser tab.
                if (!this.currentApp) {
                    // No active app, so create a generic browser tab and switch to it
                    this.createTab('browser', finalUrl);
                    this.switchToApp('browser');
                    return;
                }
                const app = this.getOrCreateApp(this.currentApp);
                const tab = app.tabs.find(t => t.id === app.activeTabId);
                if (tab) {
                    tab.url = finalUrl;
                    tab.title = this.extractTitleFromUrl(finalUrl);
                    const container = document.getElementById(tab.id);
                    // Replace iframe content with new URL (recreating iframe for security)
                    container.innerHTML = `<iframe src="${finalUrl}" sandbox="allow-same-origin allow-scripts allow-forms allow-popups allow-top-navigation"></iframe>`;
                    const iframe = container.querySelector('iframe');
                    iframe.addEventListener('load', () => {
                        try {
                            const pageTitle = iframe.contentDocument.title;
                            if (pageTitle) {
                                tab.title = pageTitle;
                                this.renderTabs(this.currentApp);
                                this.saveState();
                            }
                        } catch (e) {
                            // Cross-origin access denied; ignore
                        }
                    });
                    this.renderTabs(this.currentApp);
                    this.saveState();
                }
            }

            /**
             * Navigate back in the iframe's history.
             */
            goBack() {
                const iframe = document.querySelector('.iframe-container.active iframe');
                if (iframe && iframe.contentWindow) {
                    iframe.contentWindow.history.back();
                }
            }

            /**
             * Navigate forward in the iframe's history.
             */
            goForward() {
                const iframe = document.querySelector('.iframe-container.active iframe');
                if (iframe && iframe.contentWindow) {
                    iframe.contentWindow.history.forward();
                }
            }

            /**
             * Reload the current iframe.
             */
            refresh() {
                const iframe = document.querySelector('.iframe-container.active iframe');
                if (iframe) {
                    try {
                        // Attempt to reload via the iframe's contentWindow
                        iframe.contentWindow.location.reload();
                    } catch {
                        // Fallback: reset the src attribute
                        iframe.src = iframe.src;
                    }
                }
            }

            /**
             * Open the current tab's URL in a new browser tab. Useful when a site refuses to load in an iframe.
             */
            openExternal() {
                // Determine the current tab's URL
                let url = null;
                if (this.currentApp) {
                    const app = this.getOrCreateApp(this.currentApp);
                    const tab = app.tabs.find(t => t.id === app.activeTabId);
                    if (tab) {
                        url = tab.url;
                    }
                }
                // If no current app or url, try to use value from URL input
                if (!url) {
                    url = document.getElementById('urlInput').value.trim();
                    if (url && !/^[a-zA-Z]+:\/\//.test(url)) {
                        url = url.includes('.') ? `https://${url}` : `https://www.google.com/search?q=${encodeURIComponent(url)}`;
                    }
                }
                if (url) {
                    window.open(url, '_blank');
                }
            }

            /**
             * Extract a friendly tab title from a URL. Falls back to shortened URL if parsing fails.
             * @param {string} url - The URL from which to extract the title.
             * @returns {string} - A user-friendly title.
             */
            extractTitleFromUrl(url) {
                try {
                    const urlObj = new URL(url);
                    const hostname = urlObj.hostname.replace(/^www\./, '');
                    const pathname = urlObj.pathname;
                    // Use the last meaningful segment of the path as a human-friendly title when possible
                    const segments = pathname.split('/').filter(Boolean);
                    if (segments.length > 0) {
                        let slug = segments[segments.length - 1];
                        // Decode and replace separators with spaces
                        slug = decodeURIComponent(slug).replace(/[-_]+/g, ' ');
                        // Capitalize first letter of each word
                        slug = slug.replace(/\b\w/g, c => c.toUpperCase());
                        return slug;
                    }
                    return hostname;
                } catch {
                    return url.length > 20 ? `${url.slice(0, 17)}...` : url;
                }
            }

            /**
             * Retrieve an existing app configuration or create a new generic browser app if it doesn't exist.
             * @param {string} appId - The identifier of the app to retrieve or create.
             * @returns {object} - The app configuration.
             */
            getOrCreateApp(appId) {
                if (!this.apps.has(appId)) {
                    this.apps.set(appId, {
                        id: appId,
                        name: appId,
                        icon: '🌐',
                        defaultUrl: 'about:blank',
                        tabs: [],
                        activeTabId: null
                    });
                    // Re-render the dock to include the new app and persist the change
                    this.renderDock();
                    this.saveState();
                }
                return this.apps.get(appId);
            }

            /**
             * Add a new app to the dock via user prompts. Prompts for app name, URL, and icon,
             * then creates the app, renders the dock, and saves state.
             */
            addApp() {
                const name = prompt('Enter a name for your app:');
                if (!name) return;
                const url = prompt('Enter the default URL for this app (e.g., https://example.com):');
                if (!url) return;
                let icon = prompt('Enter an emoji to use as the icon (leave blank for 🌐):');
                if (!icon) icon = '🌐';
                // Derive an ID by slugifying the name
                const id = name.toLowerCase().trim().replace(/\s+/g, '-');
                if (this.apps.has(id)) {
                    alert('An app with that name already exists.');
                    return;
                }
                this.apps.set(id, {
                    id,
                    name,
                    icon,
                    defaultUrl: url,
                    tabs: [],
                    activeTabId: null
                });
                this.renderDock();
                this.saveState();
            }

            /**
             * Delete an app/workspace from the dock. Removes its tabs and frames, and updates state.
             * @param {string} appId - The identifier of the app to delete.
             */
            deleteApp(appId) {
                if (!this.apps.has(appId)) return;
                // Delete without confirmation for broader compatibility
                const app = this.apps.get(appId);
                // Remove iframe containers for this app's tabs
                app.tabs.forEach(tab => {
                    const container = document.getElementById(tab.id);
                    if (container) container.remove();
                });
                // If the deleted app is currently active, clear the tab bar and show welcome screen
                if (this.currentApp === appId) {
                    document.querySelectorAll('.tab').forEach(elem => elem.remove());
                    this.currentApp = null;
                    document.getElementById('urlInput').value = '';
                    document.getElementById('welcomeScreen').style.display = 'flex';
                }
                // Remove app from the map and re-render dock
                this.apps.delete(appId);
                this.renderDock();
                this.saveState();
            }

            /**
             * Open the settings panel and populate it with the current list of workspaces.
             */
            openSettings() {
                this.renderSettingsList();
                const panel = document.getElementById('settingsPanel');
                panel.style.display = 'flex';
            }

            /**
             * Close the settings panel and persist any pending changes.
             */
            closeSettings() {
                const panel = document.getElementById('settingsPanel');
                panel.style.display = 'none';
                this.saveState();
            }

            /**
             * Render the settings list. Creates rows with inputs and controls for each workspace.
             */
            renderSettingsList() {
                const listElem = document.getElementById('settingsList');
                listElem.innerHTML = '';
                const appsArray = Array.from(this.apps.entries());
                appsArray.forEach(([id, app], index) => {
                    const row = document.createElement('div');
                    row.className = 'settings-row';
                    row.dataset.appId = id;

                    // Icon input
                    const iconInput = document.createElement('input');
                    iconInput.type = 'text';
                    iconInput.value = app.icon;
                    iconInput.addEventListener('input', e => {
                        app.icon = e.target.value || '🌐';
                        this.renderDock();
                        this.saveState();
                    });
                    row.appendChild(iconInput);

                    // Name input
                    const nameInput = document.createElement('input');
                    nameInput.type = 'text';
                    nameInput.value = app.name;
                    nameInput.addEventListener('input', e => {
                        app.name = e.target.value || id;
                        this.renderDock();
                        this.saveState();
                    });
                    row.appendChild(nameInput);

                    // Default URL input
                    const urlInput = document.createElement('input');
                    urlInput.type = 'text';
                    urlInput.value = app.defaultUrl;
                    urlInput.addEventListener('input', e => {
                        app.defaultUrl = e.target.value;
                        this.saveState();
                    });
                    row.appendChild(urlInput);

                    // Up button
                    const upBtn = document.createElement('button');
                    upBtn.textContent = '↑';
                    upBtn.disabled = index === 0;
                    upBtn.addEventListener('click', () => {
                        this.moveApp(id, -1);
                    });
                    row.appendChild(upBtn);

                    // Down button
                    const downBtn = document.createElement('button');
                    downBtn.textContent = '↓';
                    downBtn.disabled = index === appsArray.length - 1;
                    downBtn.addEventListener('click', () => {
                        this.moveApp(id, 1);
                    });
                    row.appendChild(downBtn);

                    // Delete button
                    const delBtn = document.createElement('button');
                    delBtn.textContent = 'Delete';
                    delBtn.addEventListener('click', () => {
                        this.deleteApp(id);
                        // After deletion, re-render the settings list
                        this.renderSettingsList();
                    });
                    row.appendChild(delBtn);

                    listElem.appendChild(row);
                });
            }

            /**
             * Move an app up or down in the list. direction -1 for up, 1 for down.
             * @param {string} appId - The ID of the app to move.
             * @param {number} direction - -1 to move up, 1 to move down.
             */
            moveApp(appId, direction) {
                const entries = Array.from(this.apps.entries());
                const index = entries.findIndex(([id]) => id === appId);
                if (index < 0) return;
                const newIndex = index + direction;
                if (newIndex < 0 || newIndex >= entries.length) return;
                // Swap entries
                const tmp = entries[index];
                entries[index] = entries[newIndex];
                entries[newIndex] = tmp;
                // Rebuild the Map in new order
                this.apps = new Map(entries);
                this.renderDock();
                this.renderSettingsList();
                this.saveState();
            }
        }

        // Instantiate and initialize the virtual desktop once DOM is fully loaded
        window.addEventListener('DOMContentLoaded', () => {
            const desktop = new VirtualDesktop();
        });
        // Settings panel functionality will be added below
    </script>

    <!-- Settings panel for managing workspaces -->
    <div id="settingsPanel" class="settings-panel">
        <div class="settings-content">
            <h3>Manage Workspaces</h3>
            <div id="settingsList"></div>
            <div style="margin-top: 12px; text-align: right;">
                <button id="settingsClose" style="padding: 6px 12px; border: none; background: #667eea; color: #fff; border-radius: 4px; cursor: pointer;">Close</button>
            </div>
        </div>
    </div>

</body>
</html>
